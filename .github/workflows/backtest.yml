name: Backtest SMA & OCO

on:
  workflow_dispatch:
    inputs:
      watch:
        description: "watchlist file (例: watchlist_module.py)"
        required: true
        default: "watchlist_module.py"
      start:
        description: "start YYYY-MM-DD"
        required: true
        default: "2023-01-01"
      end:
        description: "end YYYY-MM-DD"
        required: true
        default: "2025-12-31"
      limit:
        description: "max tickers to test"
        required: false
        default: "300"
      tp:
        description: "take profit (例 0.06 = +6%)"
        required: false
        default: "0.06"
      sl:
        description: "stop loss (例 0.03 = -3%)"
        required: false
        default: "0.03"
      hold_max:
        description: "max holding days"
        required: false
        default: "60"
      priority:
        description: "TP_first / SL_first / GapFair"
        required: false
        default: "GapFair"

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backtest
        run: |
          python backtest_sma_oco.py \
            --watch "${{ inputs.watch }}" \
            --start "${{ inputs.start }}" \
            --end "${{ inputs.end }}" \
            --tp "${{ inputs.tp }}" \
            --sl "${{ inputs.sl }}" \
            --hold-max "${{ inputs.hold_max }}" \
            --outdir backtest_out

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-results
          path: backtest_out/*.csv
